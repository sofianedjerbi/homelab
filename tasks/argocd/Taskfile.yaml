version: '3'

vars:
  OVERLAY: etcdme-nbg1-dc3
  REPO_URL: https://github.com/sofianedjerbi/homelab

tasks:
  generate-secrets:
    desc: Generate secrets file (requires AWS_* and SOPS_AGE_KEY env vars)
    cmds:
      - ./tasks/scripts/generate-secrets.sh {{.OVERLAY}}

  bootstrap:
    desc: Bootstrap ArgoCD (run once after cluster creation)
    cmds:
      - echo "Creating namespaces..."
      - |
        for ns in argocd cert-manager keycloak postgres monitoring; do
          kubectl create namespace $ns --dry-run=client -o yaml | kubectl apply -f -
        done
      - echo "Applying secrets..."
      - sops -d argocd/overlays/{{.OVERLAY}}/secrets.sops.yaml | kubectl apply -f -
      - echo "Installing ArgoCD via Helmfile..."
      - helmfile -f argocd/helmfile.yaml apply
      - echo "Applying root application..."
      - |
        sed -e 's|REPO_URL_PLACEHOLDER|{{.REPO_URL}}|' \
            -e 's|OVERLAY_PATH_PLACEHOLDER|argocd/overlays/{{.OVERLAY}}|' \
            argocd/base/apps/root-app.yaml | kubectl apply -f -
      - echo "âœ… ArgoCD bootstrapped! Sync will start automatically."

  password:
    desc: Get ArgoCD admin password
    cmds:
      - kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d && echo
